---
layout: home
title: Feature - Coupons effects
sidebar: features
lang: fr
subnav: features_coupons_effects
---

# Les effets des coupons

## Comment crée un nouveau type de coupon ?

>Notre exemple se base sur un coupon donnant droit à un produit particulier (goodie) à tout client qui l'utilise et qui entre dans les critères d'éligibilité. Si vous avez du mal à suivre nos explications, vous trouvez l'ensemble du code dans un module correspondant sur on [GitHub](https://github.com/gmorel/thelia2-coupon-give-free-product).


1) **Implémentation** : un coupon doit implémenter l'interface [Thelia\Coupon\Type\CouponInterface](https://github.com/thelia/thelia/blob/master/core/lib/Thelia/Coupon/Type/CouponInterface.php).

Afin de ganger du temps, nous recommandons que votre classe ```GivePRoduct```étende la classe abstraite Thelia [Thelia\Coupon\Type\CouponAbstract](https://github.com/thelia/thelia/blob/master/core/lib/Thelia/Coupon/Type/CouponAbstract.php).

Veuillez créer votre nouvelle classe ```GiveProduct``` au sein d'un module. De préférence cette classe est a créer dans le dossier ```local/modules/MyModule/Coupon/Type/``` afin de favoriser l'organisation du code.


2) **Déclaration** : afin d'informer Thelia de l'existence de votre nouveau coupon, vous devez l'enregistrer en tant que [Service](http://symfony.com/doc/current/book/service_container.html) dans le fichier ``` local/modules/MyModule/Config/config.xml ``` :

```xml
<services>
    <service id="thelia.coupon.type.give_product" class="CouponGiveProduct\Coupon\Type\GiveProduct">
        <argument type="service" id="thelia.facade" />
        <tag name="thelia.coupon.addCoupon"/>
    </service>
</services>
```

Vous créez en fait un nouveau service ayant l'identifiant (`id`) ```thelia.coupon.type.give_product```, définie par la classe ```CouponGiveProduct\Coupon\Type\GiveProduct``` ayant pour façade id ```thelia.facade``` qui est lui-même un service par ailleurs. Et comme il est taggué avec ```thelia.coupon.addCoupon``` Thelia l'ajoutera automatiquement à la liste des coupons disponibles.



3) **Internationalisation (i18n)** : vous devrez impléenter 3 méthode d'internationalisation qui décrivent le coupon dans le fichier ``` local/modules/MyModule/Coupon/Type/GiveProduct.php ```

* ```getName()``` renvoie le nom internationalisé de votre coupon.
  Ex: "Ajoute un produit gratuit dans au panier"
* ```getInputName()``` renvoie le nom i18n de l'effet produit par la saisie du coupon
  Ex: "Le produit a été ajoute au panier"
* ```getToolTip()``` renvoie la description i18n du coupon.
  Ex : "Ce coupon ajoutera le produit associé au panier du client. Le coupon s'assurera qu'une commande ne peut obtenir qu'un seule produit gratuit".



4) **Comportement** : cette méthode est responsable du fonctionnement du coupon. C'est ici que réside toute la force de notre coupon :

La méthode ```exec()``` contient toute la logique du coupon.
Elle applique l'effet du coupon et retourne la réduction (qui peut être égale à 0).

![caution](/img/caution.png) **Attention ! La méthode est exécutée à cahque fois que le coupon est saisi, que la commande ait été payée ou non**

Exemple :

Dans le fichier ``` local/modules/MyModule/Coupon/Type/GiveProduct.php ```

```php
/**
 * Return effects generated by the coupon
 * A new product in the cart
 *
 * @return float The discount
 */
public function exec()
{
    // The CartItem price will be set to 0
    // So no need to return a discount
    $discount = 0;

    // Since the exec method will be called each time the cart checks its integrity
    //  We need to check if the free product has already been inserted in the Cart
    if (!$this->isAlreadyInCart($this->productSaleElementsId)) {

        /** @var ProductSaleElements $productToGive */
        $productToGive = $this->getFreeProduct();
        $this->addProductToCustomerCart($productToGive);
    }

    return $discount;
}
```

Vous pouvez avoir un aperçu de la logique du coupon (récupération du produit, ajout au panier, les événements et actions) sur [GitHub](https://github.com/gmorel/thelia2-coupon-give-free-product).



5) **Type de coupon (service id)** : vous devrez implémenter cet attribut dans le fichier ``` local/modules/MyModule/Coupon/Type/GiveProduct.php ```

```php
/** @var string Service Id  */
protected $serviceId = 'thelia.coupon.type.give_product';
```

où ```give_product``` est l'identifiant unique de votre coupon tel que défini à l'étape 2. Il s'agit du nom du [service](http://symfony.com/doc/current/book/service_container.html).



6) **Champs de saisis personnalisés** : vous pourriez avoir besoin de plus de paramètres que ceux par défaut ```amount``` and ```percent``` ?

Dans notre exemple nous avons besoin de deux paramètres supplémentaire : ```product_sale_element_id``` et ```quantity```. Il nous faut donc déclarer 2 champs de saisie supplémentaires.

Pour ce faire nous pouvons déclarer des constantes ayant pour valeurs le nom des champs pour faciliter la maintenance et la lisibilité du code.

Dans le fichier ``` local/modules/MyModule/Coupon/Type/GiveProduct.php ```

```php
/** ProductSaleElement id input name */
const INPUT_PRODUCT_SALE_ELEMENT_ID_NAME = 'product_sale_element_id';
/** Product quantity input name */
const INPUT_QUANTITY_NAME = 'quantity';
```

Vous pouvez également implémenter ces champs comme attributs de la classe et définir leurs getters. Cela pourrait être utile par la suite.

Dans le fichier ``` local/modules/MyModule/Coupon/Type/GiveProduct.php ```

```php
/** @var int Product Sale Element id you wish to offer */
protected $productSaleElementsId = 0;

/** @var int Quantity of Free product given for a Coupon */
protected $quantity = 1;

/**
 * Get Product Sale Element id to give
 *
 * @return int
 */
public function getProductSaleElementsId()
{
    return $this->productSaleElementsId;
}

/**
 * Get quantity to give
 *
 * @return int
 */
public function getQuantity()
{
    return $this->quantity;
}
```

Afin d'attribuer une valeur à ces attributs vous devrez surcharger la méthode par défaut ```set()```.

```php
/**
 * Set Coupon
 *
 * @param FacadeInterface $facade                     Valeurs obligatoires, héritées de Thelia
 * @param string          $code                       Code du coupon (ex: NOEL2020)
 * @param string          $title                      Titre du coupon (ex: Opération Barbe blanche)
 * @param string          $shortDescription           Description réduite du coupon
 * @param string          $description                Description du coupon
 * @param array           $effects                    Paramètres des effets du coupon
 * @param bool            $isCumulative               Si le coupon peut être cumulé (à d'autres offres)
 * @param bool            $isRemovingPostage          Si le coupon supprome les frais de port
 * @param bool            $isAvailableOnSpecialOffers Si le coupon est déjà actové pour le produit
 *                                                    on special offer price
 * @param bool            $isEnabled                  False si le coupon est désactivé par l'admin
 * @param int             $maxUsage                   Nombre d'utilisation restant
 * @param \Datetime       $expirationDate             Date d'expiration du coupon
 *
 * @return $this
 */
public function set(
    FacadeInterface $facade,
    $code,
    $title,
    $shortDescription,
    $description,
    array $effects,
    $isCumulative,
    $isRemovingPostage,
    $isAvailableOnSpecialOffers,
    $isEnabled,
    $maxUsage,
    \DateTime $expirationDate
)
{
    // We use the default behavior we will extend
    parent::set(
        $facade, $code, $title, $shortDescription, $description, $effects, $isCumulative, $isRemovingPostage, $isAvailableOnSpecialOffers, $isEnabled, $maxUsage, $expirationDate
    );

    if (isset($effects[self::INPUT_PRODUCT_SALE_ELEMENT_ID_NAME])) {
        $this->productSaleElementsId = $effects[self::INPUT_PRODUCT_SALE_ELEMENT_ID_NAME];
    }
    if (isset($effects[self::INPUT_QUANTITY_NAME])) {
        $this->quantity = $effects[self::INPUT_QUANTITY_NAME];
    }

    return $this;
}
```

A l'heure actuelle Thelia n'est pas capable de dessiner ces champs de saisie supplémentaire dans le back-office.
Etant une fonctionnalité du coeur de Thelia, nous avons choisi de vous laisser libre de personnaliser la manière dont ces champs sont affichés. Ainsi vous pourrez définir le design et l'ergonomie souhaités sans être contraint par une structure rigide prédéfinie.

Dans le fichier ``` local/modules/MyModule/Coupon/Type/GiveProduct.php ```

```php
/**
 * Draw the input displayed in the BackOffice
 * allowing Admin to set its Coupon effect
 *
 * @return string HTML string
 */
public function drawBackOfficeInputs()
{
    $labelProductSaleElementId = $this->getInputName();
    $labelQuantity = $this->getInputQuantityName();
    $value = $this->productSaleElementsId;

    $innerSelectHtml = $this->drawBackOfficePSESelect($value);

    $html = '
            <input type="hidden" name="thelia_coupon_creation[' . self::INPUT_AMOUNT_NAME . ']" value="0"/>
            <div class="form-group input-' . self::INPUT_PRODUCT_SALE_ELEMENT_ID_NAME . '">
                <label for="' . self::INPUT_PRODUCT_SALE_ELEMENT_ID_NAME . '" class="control-label">' . $labelProductSaleElementId . '</label>
                <select id="' . self::INPUT_PRODUCT_SALE_ELEMENT_ID_NAME . '" class="form-control" name="' . self::INPUT_EXTENDED__NAME . '[' . self::INPUT_PRODUCT_SALE_ELEMENT_ID_NAME . ']' . '" >' . $innerSelectHtml . '</select>
            </div>
            <div class="form-group input-' . self::INPUT_QUANTITY_NAME . '">
                <label for="' . self::INPUT_QUANTITY_NAME . '" class="control-label">' . $labelQuantity . '</label>
                <input id="' . self::INPUT_QUANTITY_NAME . '" class="form-control" name="' . self::INPUT_EXTENDED__NAME . '[' . self::INPUT_QUANTITY_NAME . ']' . '" type="text" value="' . $this->quantity . '"/>
            </div>
        ';

    return $html;
}
```

Inclure du code code HTML dans du code PHP n'est pas vraiment une bonne pratique.
Il serait préférable de définir la présentation des champs de saisie dans un template Smarty et l'afficher via le parseur Smarty.



7) **Enregistrement des champs de saisie** : à l'heure actuelle, Thelia est incapable de deviner quels champs diovent être sérialisés en JSON dans la colonne `serialized_effects` de la table **coupon**.
Afin d'indiquer à Thelia comment enregistrer vos nouveaux paramètres il vous suffit de surcharger l'attribut `$extendedInputs` dans la classe ```GiveProduct```de votre module.

Dans le fichier ``` local/modules/MyModule/Coupon/Type/GiveProduct.php ```

```php
/** @var array Extended Inputs to manage */
protected $extendedInputs = array(
    self::INPUT_PRODUCT_SALE_ELEMENT_ID_NAME,
    self::INPUT_QUANTITY_NAME
);
```

Votre nouveau type de coupon est prêt. Il ne vous reste plus qu'à activer le module dans le back-office.
